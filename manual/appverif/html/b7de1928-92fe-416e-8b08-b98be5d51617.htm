<html DIR="LTR" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:ddue="http://ddue.schemas.microsoft.com/authoring/2003/5" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:tool="http://www.microsoft.com/tooltip"><head><META HTTP-EQUIV="Content-Type" CONTENT="text/html; CHARSET=Windows-1252"></META><META NAME="save" CONTENT="history"></META><title>Debugging Handles Errors</title><link rel="stylesheet" type="text/css" href="../local/Classic.css"></link><script src="../local/script.js"></script></head><body><div><input type="hidden" id="userDataCache" class="userDataStyle"></input><input type="hidden" id="hiddenScrollOffset"></input></div><img id="dropDownImage" style="display:none; height:0; width:0;" src="../local/drpdown.gif"></img><img id="dropDownHoverImage" style="display:none; height:0; width:0;" src="../local/drpdown_orange.gif"></img><img id="collapseImage" style="display:none; height:0; width:0;" src="../local/collapse.gif"></img><img id="expandImage" style="display:none; height:0; width:0;" src="../local/exp.gif"></img><img id="copyImage" style="display:none; height:0; width:0;" src="../local/copycode.gif"></img><img id="copyHoverImage" style="display:none; height:0; width:0;" src="../local/copycodeHighlight.gif"></img><div id="header"><table width="100%" id="topTable"><tr id="headerTableRow1"><td align="left"><span id="runningHeaderText"></span></td></tr><tr id="headerTableRow2"><td align="left"><span id="nsrTitle">Debugging Handles Errors</span></td></tr><tr id="headerTableRow3"><td></td></tr></table></div><div id="mainSection"><div id="mainBody"><div id="allHistory" class="saveHistory" onsave="saveAll()" onload="loadAll()"></div><h2 class="heading">!htrace debugger extension</h2><div id="sectionSection0" class="section"><content xmlns="http://ddue.schemas.microsoft.com/authoring/2003/5"><p xmlns="">!htrace can be used in both user-mode debugger and kernel debugger to display stack trace information for one or all the handles in a process. This information is available if handle tracing is enabled for the process – automatically enabled if handle checking is enabled in the application verifier. Stack traces are saved every time the process is opening or closing a handle or when it is referencing an invalid handle. </p><p xmlns="">The kernel debugger syntax for this extension is:</p><p xmlns="">     !htrace [ handle [process] ]    </p><p xmlns="">If handle is not specified or is 0, information about all the handles in the process will be displayed. If process is not specified, the current process will be used.</p><p xmlns="">The user-mode debugger syntax is:</p><p xmlns="">     !htrace [handle] </p><p xmlns="">The user-mode debugger extension always displays information about the current debugee process.</p><p xmlns="">Examples:</p></content></div><h2 class="heading">Dump information about handle 7CC in process 815328b0</h2><div id="sectionSection1" class="section"><content xmlns="http://ddue.schemas.microsoft.com/authoring/2003/5"><p xmlns="">kd&gt; !htrace 7CC 815328b0</p><p xmlns="">Loaded \\...\kdexts extension DLL</p><p xmlns="">Process 0x815328B0</p><p xmlns="">ObjectTable 0xE15ECBB8</p><p xmlns="">--------------------------------------</p><p xmlns="">Handle 0x7CC - CLOSE:</p><p xmlns="">0x8018FCB9: ntoskrnl!ExDestroyHandle+0x103</p><p xmlns="">0x801E1D12: ntoskrnl!ObpCloseHandleTableEntry+0xE4</p><p xmlns="">0x801E1DD9: ntoskrnl!ObpCloseHandle+0x85</p><p xmlns="">0x801E1EDD: ntoskrnl!NtClose+0x19</p><p xmlns="">0x77DBFCD6: KERNEL32!GetLocaleFileInfo+0x3D</p><p xmlns="">0x77DBF942: KERNEL32!NlsProcessInitialize+0x11D</p><p xmlns="">0x77E0C6DF: KERNEL32!NlsDllInitialize+0x35</p><p xmlns="">0x6A20785C: ntdll!LdrpCallInitRoutine+0x14</p><p xmlns="">0x6A205393: ntdll!LdrpRunInitializeRoutines+0x1D9</p><p xmlns="">0x6A20DD80: ntdll!LdrpInitializeProcess+0xAF6</p><p xmlns="">--------------------------------------</p><p xmlns="">Handle 0x7CC - OPEN:</p><p xmlns="">0x8018F44A: ntoskrnl!ExCreateHandle+0x94</p><p xmlns="">0x801E3180: ntoskrnl!ObpCreateHandle+0x304</p><p xmlns="">0x801E1563: ntoskrnl!ObOpenObjectByName+0x1E9</p><p xmlns="">0x77DBFCD6: KERNEL32!GetLocaleFileInfo+0x3D</p><p xmlns="">0x77DBF942: KERNEL32!NlsProcessInitialize+0x11D</p><p xmlns="">0x77E0C6DF: KERNEL32!NlsDllInitialize+0x35</p><p xmlns="">0x6A20785C: ntdll!LdrpCallInitRoutine+0x14</p><p xmlns="">0x6A205393: ntdll!LdrpRunInitializeRoutines+0x1D9</p><p xmlns="">0x6A20DD80: ntdll!LdrpInitializeProcess+0xAF6</p><p xmlns="">--------------------------------------</p><p xmlns="">Parsed 0x1CA stack traces.</p><p xmlns="">Dumped 0x2 stack traces.</p></content></div><h2 class="heading">Dump information about all handles in process 815328b0</h2><div id="sectionSection2" class="section"><content xmlns="http://ddue.schemas.microsoft.com/authoring/2003/5"><p xmlns="">kd&gt; !htrace 0 81400300</p><p xmlns="">Process 0x81400300</p><p xmlns="">ObjectTable 0xE10CCF60</p><p xmlns="">--------------------------------------</p><p xmlns="">Handle 0x7CC - CLOSE:</p><p xmlns="">0x8018FCB9: ntoskrnl!ExDestroyHandle+0x103</p><p xmlns="">0x801E1D12: ntoskrnl!ObpCloseHandleTableEntry+0xE4</p><p xmlns="">0x801E1DD9: ntoskrnl!ObpCloseHandle+0x85</p><p xmlns="">0x801E1EDD: ntoskrnl!NtClose+0x19</p><p xmlns="">0x010012C1: badhandle!mainCRTStartup+0xE3</p><p xmlns="">0x77DE0B2F: KERNEL32!BaseProcessStart+0x3D</p><p xmlns="">--------------------------------------</p><p xmlns="">Handle 0x7CC - OPEN:</p><p xmlns="">0x8018F44A: ntoskrnl!ExCreateHandle+0x94</p><p xmlns="">0x801E3390: ntoskrnl!ObpCreateUnnamedHandle+0x10C</p><p xmlns="">0x801E7317: ntoskrnl!ObInsertObject+0xC3</p><p xmlns="">0x77DE23B2: KERNEL32!CreateSemaphoreA+0x66</p><p xmlns="">0x010011C5: badhandle!main+0x45</p><p xmlns="">0x010012C1: badhandle!mainCRTStartup+0xE3</p><p xmlns="">0x77DE0B2F: KERNEL32!BaseProcessStart+0x3D</p><p xmlns="">--------------------------------------</p><p xmlns="">Handle 0x7DC - BAD REFERENCE:</p><p xmlns="">0x8018F709: ntoskrnl!ExMapHandleToPointerEx+0xEA</p><p xmlns="">0x801E10F2: ntoskrnl!ObReferenceObjectByHandle+0x12C</p><p xmlns="">0x801902BE: ntoskrnl!NtSetEvent+0x6C</p><p xmlns="">0x80154965: ntoskrnl!_KiSystemService+0xC4</p><p xmlns="">0x010012C1: badhandle!mainCRTStartup+0xE3</p><p xmlns="">0x77DE0B2F: KERNEL32!BaseProcessStart+0x3D</p><p xmlns="">--------------------------------------</p><p xmlns="">Handle 0x7DC - CLOSE:</p><p xmlns="">0x8018FCB9: ntoskrnl!ExDestroyHandle+0x103</p><p xmlns="">0x801E1D12: ntoskrnl!ObpCloseHandleTableEntry+0xE4</p><p xmlns="">0x801E1DD9: ntoskrnl!ObpCloseHandle+0x85</p><p xmlns="">0x801E1EDD: ntoskrnl!NtClose+0x19</p><p xmlns="">0x010012C1: badhandle!mainCRTStartup+0xE3</p><p xmlns="">0x77DE0B2F: KERNEL32!BaseProcessStart+0x3D</p><p xmlns="">--------------------------------------</p><p xmlns="">Handle 0x7DC - OPEN:</p><p xmlns="">0x8018F44A: ntoskrnl!ExCreateHandle+0x94</p><p xmlns="">0x801E3390: ntoskrnl!ObpCreateUnnamedHandle+0x10C</p><p xmlns="">0x801E7317: ntoskrnl!ObInsertObject+0xC3</p><p xmlns="">0x77DE265C: KERNEL32!CreateEventA+0x66</p><p xmlns="">0x010011A0: badhandle!main+0x20</p><p xmlns="">0x010012C1: badhandle!mainCRTStartup+0xE3</p><p xmlns="">0x77DE0B2F: KERNEL32!BaseProcessStart+0x3D</p><p xmlns="">--------------------------------------</p><p xmlns="">Parsed 0x6 stack traces.</p><p xmlns="">Dumped 0x5 stack traces.</p></content></div><h2 class="heading">Dump information about handle 7DC in the current process</h2><div id="sectionSection3" class="section"><content xmlns="http://ddue.schemas.microsoft.com/authoring/2003/5"><p xmlns="">kd&gt; !htrace  7DC</p><p xmlns="">Process 0x81400300</p><p xmlns="">ObjectTable 0xE10CCF60</p><p xmlns="">--------------------------------------</p><p xmlns="">Handle 0x7DC - BAD REFERENCE:</p><p xmlns="">0x8018F709: ntoskrnl!ExMapHandleToPointerEx+0xEA</p><p xmlns="">0x801E10F2: ntoskrnl!ObReferenceObjectByHandle+0x12C</p><p xmlns="">0x801902BE: ntoskrnl!NtSetEvent+0x6C</p><p xmlns="">0x80154965: ntoskrnl!_KiSystemService+0xC4</p><p xmlns="">0x010012C1: badhandle!mainCRTStartup+0xE3</p><p xmlns="">0x77DE0B2F: KERNEL32!BaseProcessStart+0x3D</p><p xmlns="">--------------------------------------</p><p xmlns="">Handle 0x7DC - CLOSE:</p><p xmlns="">0x8018FCB9: ntoskrnl!ExDestroyHandle+0x103</p><p xmlns="">0x801E1D12: ntoskrnl!ObpCloseHandleTableEntry+0xE4</p><p xmlns="">0x801E1DD9: ntoskrnl!ObpCloseHandle+0x85</p><p xmlns="">0x801E1EDD: ntoskrnl!NtClose+0x19</p><p xmlns="">0x010012C1: badhandle!mainCRTStartup+0xE3</p><p xmlns="">0x77DE0B2F: KERNEL32!BaseProcessStart+0x3D</p><p xmlns="">--------------------------------------</p><p xmlns="">Handle 0x7DC - OPEN:</p><p xmlns="">0x8018F44A: ntoskrnl!ExCreateHandle+0x94</p><p xmlns="">0x801E3390: ntoskrnl!ObpCreateUnnamedHandle+0x10C</p><p xmlns="">0x801E7317: ntoskrnl!ObInsertObject+0xC3</p><p xmlns="">0x77DE265C: KERNEL32!CreateEventA+0x66</p><p xmlns="">0x010011A0: badhandle!main+0x20</p><p xmlns="">0x010012C1: badhandle!mainCRTStartup+0xE3</p><p xmlns="">0x77DE0B2F: KERNEL32!BaseProcessStart+0x3D</p><p xmlns="">--------------------------------------</p><p xmlns="">Parsed 0x6 stack traces.</p><p xmlns="">Dumped 0x3 stack traces.</p><p xmlns=""></p></content></div><!--[if gte IE 5]>
			<tool:tip element="languageFilterToolTip" avoidmouse="false"/>
		<![endif]--></div><div id="footer"><p></p><hr></hr><br /><br /></div></div></body></html>